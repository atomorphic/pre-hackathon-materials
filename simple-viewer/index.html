<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple DICOM Viewer - Learning Example</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #1a1a2e;
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      padding: 15px 20px;
      background: #16213e;
      border-bottom: 1px solid #333;
    }
    .header h1 { font-size: 18px; }
    .header p { font-size: 12px; color: #888; margin-top: 5px; }
    .toolbar {
      padding: 10px 20px;
      background: #0f0f23;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .toolbar button {
      padding: 8px 16px;
      background: #0f3460;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .toolbar button:hover { background: #1a508b; }
    .toolbar button.active { background: #e94560; }
    .divider { width: 1px; height: 30px; background: #333; }
    .main {
      flex: 1;
      display: flex;
      padding: 10px;
      gap: 10px;
    }
    #viewport {
      flex: 1;
      background: black;
      min-height: 400px;
    }
    .panel {
      width: 220px;
      background: #16213e;
      border-radius: 8px;
      padding: 15px;
      font-size: 13px;
    }
    .panel h3 { font-size: 14px; margin-bottom: 10px; color: #e94560; }
    .panel .row { margin-bottom: 8px; }
    .panel .label { color: #888; }
    .status {
      padding: 8px 20px;
      background: #16213e;
      font-size: 12px;
      border-top: 1px solid #333;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Simple DICOM Viewer</h1>
    <p>Pre-Hackathon Learning Example - Study the code to understand Cornerstone3D</p>
  </div>
  
  <div class="toolbar">
    <input type="file" id="fileInput" multiple accept=".dcm" hidden>
    <button id="loadBtn">Load DICOM</button>
    <div class="divider"></div>
    <button id="wwwlBtn" class="active">W/L</button>
    <button id="panBtn">Pan</button>
    <button id="zoomBtn">Zoom</button>
    <div class="divider"></div>
    <button id="lengthBtn">Length</button>
    <button id="rectBtn">Rectangle</button>
    <div class="divider"></div>
    <button id="resetBtn">Reset</button>
  </div>
  
  <div class="main">
    <div id="viewport"></div>
    <div class="panel">
      <h3>Info</h3>
      <div class="row"><span class="label">Slice:</span> <span id="sliceInfo">-/-</span></div>
      <div class="row"><span class="label">W/L:</span> <span id="wlInfo">-/-</span></div>
      
      <h3 style="margin-top: 20px;">Instructions</h3>
      <p style="color: #aaa; line-height: 1.6; font-size: 12px;">
        1. Click "Load DICOM" to select .dcm files<br>
        2. Scroll to change slices<br>
        3. Drag for W/L adjustment<br>
        4. Use tools to annotate
      </p>
      
      <h3 style="margin-top: 20px;">Study Tips</h3>
      <p style="color: #aaa; line-height: 1.6; font-size: 12px;">
        Open browser DevTools (F12) and read the console logs.
        The code below is heavily commented!
      </p>
    </div>
  </div>
  
  <div class="status"><span id="status">Ready. Load DICOM files to begin.</span></div>

  <script type="module">
    // =========================================================================
    // SIMPLE DICOM VIEWER - LEARNING EXAMPLE
    // =========================================================================
    // This is a complete, working viewer for you to study.
    // Read through this code to understand how Cornerstone3D works.
    //
    // KEY SECTIONS:
    // 1. Imports & Initialization
    // 2. Viewport Creation
    // 3. Tools Setup
    // 4. File Loading
    // 5. Event Handlers
    // =========================================================================

    // =========================================================================
    // SECTION 1: IMPORTS
    // =========================================================================
    // Cornerstone3D has three main packages:
    // - @cornerstonejs/core: Rendering engine, viewports
    // - @cornerstonejs/tools: Interaction tools, annotations
    // - @cornerstonejs/dicom-image-loader: DICOM file loading
    //
    // We load them from a CDN for simplicity (no npm needed)
    
    import {
      init as coreInit,
      RenderingEngine,
      Enums,
    } from 'https://esm.sh/@cornerstonejs/core@1.80.1';

    import {
      init as toolsInit,
      ToolGroupManager,
      WindowLevelTool,
      PanTool,
      ZoomTool,
      StackScrollMouseWheelTool,
      LengthTool,
      RectangleROITool,
      addTool,
      Enums as ToolEnums,
    } from 'https://esm.sh/@cornerstonejs/tools@1.80.1';

    import * as dicomLoader from 'https://esm.sh/@cornerstonejs/dicom-image-loader@1.80.1';

    // =========================================================================
    // SECTION 2: INITIALIZATION
    // =========================================================================
    // Before using any Cornerstone3D features, you must initialize all packages.
    // This sets up WebGL, web workers, etc.
    
    async function initializeCornerstone() {
      console.log('Initializing Cornerstone3D...');
      
      // Initialize in order: core → loader → tools
      await coreInit();
      await dicomLoader.init();
      await toolsInit();
      
      console.log('✅ Cornerstone3D initialized');
    }

    // =========================================================================
    // SECTION 3: RENDERING ENGINE & VIEWPORT
    // =========================================================================
    // The RenderingEngine manages viewports (display areas).
    // A Viewport is where images are actually displayed.
    //
    // Types of viewports:
    // - STACK: 2D slice-by-slice viewing
    // - ORTHOGRAPHIC: MPR views (axial, sagittal, coronal)
    // - VOLUME_3D: 3D rendering
    
    const ENGINE_ID = 'myRenderingEngine';
    const VIEWPORT_ID = 'myViewport';
    const TOOLGROUP_ID = 'myToolGroup';
    
    let renderingEngine;
    let viewport;
    let toolGroup;
    
    function setupViewport() {
      console.log('Setting up viewport...');
      
      // Create the rendering engine
      renderingEngine = new RenderingEngine(ENGINE_ID);
      
      // Get the HTML element where we'll display images
      const element = document.getElementById('viewport');
      
      // Define viewport configuration
      const viewportInput = {
        viewportId: VIEWPORT_ID,
        element: element,
        type: Enums.ViewportType.STACK,  // 2D slice viewer
      };
      
      // Enable the viewport (attaches to the HTML element)
      renderingEngine.enableElement(viewportInput);
      
      // Get a reference to the viewport for later use
      viewport = renderingEngine.getViewport(VIEWPORT_ID);
      
      console.log('✅ Viewport created');
    }

    // =========================================================================
    // SECTION 4: TOOLS SETUP
    // =========================================================================
    // Tools provide user interaction (pan, zoom, annotate, etc.)
    //
    // Tool lifecycle:
    // 1. addTool() - Register the tool class globally
    // 2. toolGroup.addTool() - Add to a specific tool group
    // 3. toolGroup.addViewport() - Associate viewports with the group
    // 4. toolGroup.setToolActive() - Activate with mouse binding
    //
    // Tool states:
    // - Active: Responds to mouse, creates new annotations
    // - Passive: Can edit existing, won't create new
    // - Enabled: Visible but no interaction
    // - Disabled: Hidden
    
    function setupTools() {
      console.log('Setting up tools...');
      
      // Step 1: Register tools globally (do this ONCE)
      addTool(WindowLevelTool);
      addTool(PanTool);
      addTool(ZoomTool);
      addTool(StackScrollMouseWheelTool);
      addTool(LengthTool);
      addTool(RectangleROITool);
      
      // Step 2: Create a tool group
      // Tool groups let multiple viewports share the same tools
      toolGroup = ToolGroupManager.createToolGroup(TOOLGROUP_ID);
      
      // Step 3: Add tools to the group
      toolGroup.addTool(WindowLevelTool.toolName);
      toolGroup.addTool(PanTool.toolName);
      toolGroup.addTool(ZoomTool.toolName);
      toolGroup.addTool(StackScrollMouseWheelTool.toolName);
      toolGroup.addTool(LengthTool.toolName);
      toolGroup.addTool(RectangleROITool.toolName);
      
      // Step 4: Associate our viewport with this tool group
      toolGroup.addViewport(VIEWPORT_ID, ENGINE_ID);
      
      // Step 5: Set default active tools
      // Window/Level on left mouse button
      toolGroup.setToolActive(WindowLevelTool.toolName, {
        bindings: [{ mouseButton: ToolEnums.MouseBindings.Primary }],
      });
      
      // Scroll on mouse wheel
      toolGroup.setToolActive(StackScrollMouseWheelTool.toolName);
      
      console.log('✅ Tools configured');
    }

    // =========================================================================
    // SECTION 5: FILE LOADING
    // =========================================================================
    // To display DICOM images:
    // 1. Convert File objects to "imageIds" (URL-like identifiers)
    // 2. Set the imageIds on the viewport as a "stack"
    // 3. Render
    
    let imageIds = [];
    
    async function loadDicomFiles(files) {
      setStatus('Loading DICOM files...');
      console.log(`Loading ${files.length} files...`);
      
      // Convert each File to an imageId
      imageIds = [];
      for (const file of files) {
        // wadouri.fileManager.add() registers the file and returns an imageId
        const imageId = dicomLoader.wadouri.fileManager.add(file);
        imageIds.push(imageId);
      }
      
      if (imageIds.length === 0) {
        setStatus('No DICOM files found');
        return;
      }
      
      console.log(`Created ${imageIds.length} imageIds`);
      
      // Set the image stack on the viewport
      // Second parameter is the initial slice index (middle)
      const middleSlice = Math.floor(imageIds.length / 2);
      await viewport.setStack(imageIds, middleSlice);
      
      // Render the viewport
      viewport.render();
      
      setStatus(`Loaded ${imageIds.length} images. Scroll to navigate.`);
      updateSliceInfo();
    }

    // =========================================================================
    // SECTION 6: TOOL SWITCHING
    // =========================================================================
    // To change the active tool:
    // 1. Set current tool to passive
    // 2. Set new tool to active with mouse binding
    
    let currentTool = WindowLevelTool.toolName;
    
    function setActiveTool(toolName) {
      console.log(`Switching tool: ${currentTool} → ${toolName}`);
      
      // Deactivate current tool
      toolGroup.setToolPassive(currentTool);
      
      // Activate new tool
      toolGroup.setToolActive(toolName, {
        bindings: [{ mouseButton: ToolEnums.MouseBindings.Primary }],
      });
      
      currentTool = toolName;
      
      // Update UI
      document.querySelectorAll('.toolbar button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      setStatus(`Tool: ${toolName}`);
    }

    // =========================================================================
    // SECTION 7: UI HELPERS
    // =========================================================================
    
    function setStatus(msg) {
      document.getElementById('status').textContent = msg;
    }
    
    function updateSliceInfo() {
      if (!viewport || imageIds.length === 0) return;
      const idx = viewport.getCurrentImageIdIndex();
      document.getElementById('sliceInfo').textContent = 
        `${idx + 1}/${imageIds.length}`;
    }

    // =========================================================================
    // SECTION 8: EVENT HANDLERS
    // =========================================================================
    
    function setupEventHandlers() {
      // File input
      document.getElementById('loadBtn').onclick = () => {
        document.getElementById('fileInput').click();
      };
      
      document.getElementById('fileInput').onchange = (e) => {
        if (e.target.files.length > 0) {
          loadDicomFiles(Array.from(e.target.files));
        }
      };
      
      // Tool buttons
      document.getElementById('wwwlBtn').onclick = (e) => 
        setActiveTool(WindowLevelTool.toolName);
      document.getElementById('panBtn').onclick = (e) => 
        setActiveTool(PanTool.toolName);
      document.getElementById('zoomBtn').onclick = (e) => 
        setActiveTool(ZoomTool.toolName);
      document.getElementById('lengthBtn').onclick = (e) => 
        setActiveTool(LengthTool.toolName);
      document.getElementById('rectBtn').onclick = (e) => 
        setActiveTool(RectangleROITool.toolName);
      
      // Reset button
      document.getElementById('resetBtn').onclick = () => {
        if (viewport) {
          viewport.resetCamera();
          viewport.render();
          setStatus('View reset');
        }
      };
      
      // Update slice info on scroll
      document.getElementById('viewport').addEventListener('wheel', () => {
        setTimeout(updateSliceInfo, 50);
      });
    }

    // =========================================================================
    // SECTION 9: MAIN ENTRY POINT
    // =========================================================================
    
    async function main() {
      try {
        await initializeCornerstone();
        setupViewport();
        setupTools();
        setupEventHandlers();
        setStatus('Ready. Load DICOM files to begin.');
        console.log('✅ Application ready');
      } catch (error) {
        console.error('❌ Initialization failed:', error);
        setStatus('Error: ' + error.message);
      }
    }
    
    // Start the application
    main();
  </script>
</body>
</html>
